<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adoras - Service Worker Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #F5F9E9;
      color: #36453B;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #36453B;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .status-box {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    
    .status-box.success {
      background: #d4edda;
      color: #155724;
    }
    
    .status-box.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-box.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    button {
      background: #36453B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    
    button:hover {
      background: #2a3530;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .info {
      background: #e7f3ff;
      padding: 15px;
      border-left: 4px solid #2196F3;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      margin: 10px 0;
    }
    
    .icon {
      font-size: 20px;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Adoras Service Worker Test</h1>
    
    <div class="info">
      <strong>üì± iOS Users:</strong> If you're on iOS, open this page in Safari and add it to your home screen to test standalone mode.
    </div>
    
    <div id="status" class="status-box">
      <div id="status-content">‚è≥ Checking service worker status...</div>
    </div>
    
    <div style="margin: 20px 0;">
      <button onclick="runDiagnostic()">üîç Run Full Diagnostic</button>
      <button onclick="registerSW()">üìù Register Service Worker</button>
      <button onclick="unregisterSW()">üóëÔ∏è Unregister All</button>
      <button onclick="location.reload()">üîÑ Reload Page</button>
    </div>
    
    <div id="results"></div>
    
    <div style="margin-top: 30px;">
      <h2 style="font-size: 18px; margin-bottom: 10px;">üìä Environment Info</h2>
      <pre id="env-info"></pre>
    </div>
    
    <div style="margin-top: 30px;">
      <h2 style="font-size: 18px; margin-bottom: 10px;">üìù Console Output</h2>
      <pre id="console-output" style="max-height: 300px; overflow-y: auto;"></pre>
    </div>
  </div>
  
  <script>
    // Capture console output
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    function addToConsole(type, ...args) {
      const line = args.join(' ') + '\n';
      consoleOutput.textContent += `[${type}] ${line}`;
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      addToConsole('LOG', ...args);
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      addToConsole('ERROR', ...args);
    };
    
    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addToConsole('WARN', ...args);
    };
    
    // Show environment info
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                        window.navigator.standalone;
    
    document.getElementById('env-info').textContent = JSON.stringify({
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      isIOS: isIOS,
      isStandalone: isStandalone,
      swSupported: 'serviceWorker' in navigator,
      notificationSupported: 'Notification' in window,
      pushSupported: 'PushManager' in window,
      location: window.location.href,
      protocol: window.location.protocol,
      online: navigator.onLine
    }, null, 2);
    
    // Check initial status
    async function checkStatus() {
      const statusDiv = document.getElementById('status');
      const statusContent = document.getElementById('status-content');
      
      if (!('serviceWorker' in navigator)) {
        statusDiv.className = 'status-box error';
        statusContent.innerHTML = '<span class="icon">‚ùå</span> Service Workers not supported in this browser';
        return;
      }
      
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (registration) {
          if (registration.active) {
            statusDiv.className = 'status-box success';
            statusContent.innerHTML = `
              <span class="icon">‚úÖ</span> Service Worker is active!<br>
              Scope: ${registration.scope}<br>
              State: ${registration.active.state}
            `;
          } else if (registration.installing) {
            statusDiv.className = 'status-box warning';
            statusContent.innerHTML = '<span class="icon">‚è≥</span> Service Worker is installing...';
          } else if (registration.waiting) {
            statusDiv.className = 'status-box warning';
            statusContent.innerHTML = '<span class="icon">‚è≥</span> Service Worker is waiting...';
          } else {
            statusDiv.className = 'status-box warning';
            statusContent.innerHTML = '<span class="icon">‚ö†Ô∏è</span> Service Worker registered but not active';
          }
        } else {
          statusDiv.className = 'status-box warning';
          statusContent.innerHTML = '<span class="icon">‚ö†Ô∏è</span> No service worker registered';
        }
      } catch (error) {
        statusDiv.className = 'status-box error';
        statusContent.innerHTML = `<span class="icon">‚ùå</span> Error: ${error.message}`;
      }
    }
    
    // Run diagnostic
    async function runDiagnostic() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="status-box"><div id="diag-output">Running diagnostic...</div></div>';
      
      console.log('üîç Starting diagnostic...');
      
      try {
        const response = await fetch('/sw-diagnostic.js');
        const script = await response.text();
        eval(script);
      } catch (error) {
        console.error('Failed to load diagnostic script:', error);
      }
    }
    
    // Register service worker
    async function registerSW() {
      console.log('üìù Attempting to register service worker...');
      
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', {
          scope: '/'
        });
        
        console.log('‚úÖ Registration successful!');
        console.log('Scope:', registration.scope);
        
        if (registration.installing) {
          console.log('‚è≥ Service worker is installing...');
          registration.installing.addEventListener('statechange', (e) => {
            console.log('State:', e.target.state);
          });
        }
        
        setTimeout(checkStatus, 1000);
      } catch (error) {
        console.error('‚ùå Registration failed:', error);
      }
    }
    
    // Unregister all service workers
    async function unregisterSW() {
      console.log('üóëÔ∏è Unregistering all service workers...');
      
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        
        for (const registration of registrations) {
          await registration.unregister();
          console.log('‚úÖ Unregistered:', registration.scope);
        }
        
        console.log('‚úÖ All service workers unregistered');
        setTimeout(checkStatus, 1000);
      } catch (error) {
        console.error('‚ùå Unregistration failed:', error);
      }
    }
    
    // Check status on load
    checkStatus();
    
    // Refresh status every 2 seconds
    setInterval(checkStatus, 2000);
    
    console.log('‚úÖ Test page loaded');
  </script>
</body>
</html>
